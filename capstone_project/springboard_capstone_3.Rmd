---
title: "Springboard Capstone 3"
author: "Carlee Price"
date: "July 8, 2017"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

## A STUDY ON THE ANGEL INVESTING LANDSCAPE AND OUTCOMES FOR INVESTORS

WHAT WE HAVE:

A Crunchbase data set that reports investments in seed-stage companies. This data is a sample, reflecting some portion of the total amount of activity in this space.  It was published in 2014 and reflected activity in the space up to that point.  We're going to select from the global, long-horizon data set those companies that received first funding *in the US after 2007*. 


## PART I: WORKING WITH THE CRUNCHBASE DATA

#### a) LOAD & TRANSFORM 

```{r}
allcompanies = read.csv("companies.csv")
#keep only the companies that are US-based
companies <- subset(allcompanies, country_code == "USA")
#we also want to keep only the companies with first_funded_at dates of 2007 or later
#first cast this column as a date
companies$first_funding_at <- format(as.Date(companies$first_funding_at), "%Y/%m/%d")
companies <- subset(companies, first_funding_at >= '2007/01/01')
#View(companies)
#summary(companies)
#list of rows that have missing values
nrow(companies[!complete.cases(companies),])
# == 28793
nrow(companies) 
# == 54294
colnames(companies)
```

After subsetting the data, we have 25,836 rows of which 4,688 are incomplete.  This is a sufficiently robust set to draw conclusions about the space.

Transform the funding column into useable form (by stripping punctuation, converting to integer) and changing blanks in status column to read "unknown". Let's see how these companies performed over the study horizon, how many remained operational.  

```{r}
companies$funding_total_usd <- as.numeric(gsub("[[:punct:]]", "", companies$funding_total_usd))
levels(companies$status)[1] <- "unknown"
table(companies$status)
```

This is our first look at the win/loss ratio in this space.  Counting exits as a win (7.0%) and closeds as a loss (4.8%) looks encouraging.  Will the numbers be different if we look at just one vintage of companies.  Let's try 2007.  There are 1425 rows in this subset.


```{r}
companies07 <- subset(companies, first_funding_at <= '2007/12/31')
nrow(companies07)
table(companies07$status)
```

Here we see the wins (24.6%) and losses (14.3%) are much higher.  Spending more time in the market leads to more resolutions (closure or acquisition).

Let's get more granular, and look not just at the outcome but at the degree of success.  Closure of a business can only result in 100% loss but an exit can clearly generate > 100% returns.  We're working towards a picture of total portfolio returns.

Add two new data sets from the same source: funding rounds (amounts raised) and acquisitions (exit values).  Both will need to be tidied in a similar fashion to our companies table.  We also have an outlier in our acquisitions set: Riot Games was acquired by Tenecet for 400Mm, not the USD 4,000 noted.  

```{r}
allrounds = read.csv("rounds.csv")
rounds <- subset(allrounds, company_country_code == "USA")
#View(rounds)
#summary(rounds)
rounds$raised_amount_usd <- as.numeric(gsub("[[:punct:]]", "", rounds$raised_amount_usd))
allacquisitions = read.csv("acquisitions.csv")
acquisitions <- subset(allacquisitions, company_country_code == "USA")
acquisitions$price_amount <- as.numeric(gsub("[[:punct:]]", "", acquisitions$price_amount))
#View(acquisitions)
acquisitions$price_amount[5344] <- 400000000
#summary(acquisitions)
```

And another row with misleading information: Aptalis Pharma is listed as having raised a single round (173k seed capital) and then proceeding to exit for $2.9Bn.  That would create an impressive return indeed for funders.  The reality is that the company actually was spun out from the merger of two established pharmaceutical giants.  At the date of formation had seven branded products in market, and a robust development pipeline.  There was far more than USD 173k in value within the company.  Because this is incorrect and serves to distort our analysis, it comes out. 

We're not able to screen these new tables for "first funding" date, as we did with our companies table.  So instead we'll use a left join, which allows us to start with the screened companies table and add information from the new data sets only where it matches.  lib

```{r}
companies2 <- subset(companies, select = c(name, funding_total_usd, status, state_code, region, city, funding_rounds, founded_year, first_funding_at))
#remove Aptalis Pharma
companies2 <- companies2[-c(1584), ]  
acquisitions2 <- subset(acquisitions, select = c(company_name, company_state_code, company_region, company_city, acquirer_name, acquired_at, price_amount, price_currency_code))
#we can't simply join on name, since there are a number of unique companies that share a name.  
#create a new column namecity that 
companies2$namecity <- paste(companies2$name, companies2$city)
acquisitions2$namecity <- paste(acquisitions2$company_name, acquisitions2$company_city)
#then join them
joinedset <- merge(x = companies2, y = acquisitions2, by = "namecity", all.x = TRUE)
```

There are duplicate rows in this merged dataframe.  If we screen using unique, we remove 12 rows that are perfectly identical.  There are also companies in here which have been acquired twice (see: Forrst).  Stakeholders may in this case be getting paid twice, but not necessarily.  Further, the amount of the gain in the second case would be the differential between that and the first bid, rather than the entire amount.  This gets tricky, but only applies in cases where price is disclosed twice.

```{r}
nrow(joinedset)
subset(joinedset, name == "Catch.com")
#this one and 11 others can be eliminated with:
joinedset <- distinct(joinedset, name, first_funding_at, acquired_at, .keep_all = TRUE)
nrow(joinedset)

```

Roost is another example, with 4 entries in the companies dataset.  These are actually four different companies (founding dates, location) that simply share a name. Legitimately unique, not duplicates.  So the data appears to be sound, if slightly quirky.

#### b) DATA EXPLORATION

Now we're ready to look at returns.  Angels want to see exits, as that's the only way they're getting the money back, and the source of their returns.  Our "status" field tells us which companies have been acquired and from that we got % exits (successes). We also want dollar-on-dollar % return, which requires acquisition price information (numerator) in addition to total funding information (denominator).  

```{r}
nrow(joinedset)
test <- subset(joinedset, price_amount > 1)
nrow(test)
test$return <- test$price_amount/test$funding_total_usd
sum(test$price_amount)/sum(test$funding_total_usd, na.rm = TRUE)
plot(test$return, log = "y")
```

Only 542 of the 1867 companies described as "acquired" in our joined set include pricing information. Still a reasonable sample size, and the numbers are encouraging (8.72X return on total amount raised) but we wander into speculative territory if we fail to understand the biases in the sample (is it fair to say that acquisitions with price disclosed are generally more or less generous to investors?) extrapolate to conclusions about the population. 

If we consider just those companies with disclosed acquisition prices, compared to the total amount raised across the data set, what does that tell us? So if all of the companies that were not acquired, or were but did not disclose the acquisition price, were ultimately worth $0 what would returns on this money be (annualized IRR)?

```{r}
(sum(joinedset$funding_total_usd, na.rm = TRUE)/sum(joinedset$price_amount, na.rm = TRUE))^(1/7)-1
```

And the same just for our 2007 group:

```{r}
joinedset07 <- subset(joinedset, first_funding_at <= '2007/12/31')
(sum(joinedset07$funding_total_usd, na.rm = TRUE)/sum(joinedset07$price_amount, na.rm = TRUE))^(1/7)-1
```

Again, this is just the reported cash in hand return for companies from the class of 2007.  In order to capture a true picture of what total returns are, we need to add several pieces to this:
1) companies that were acquired for an undicslosed amount
2) companies that were acquired outside of the study h

Do companies that raise more money generate better returns for their stakeholders?  Not necessarily.  Note the slope here is negative

```{r}
lm(test$return ~ test$funding_total_usd)
plot(test$funding_total_usd, test$return, log = "xy")
abline(lm(test$return ~ test$funding_total_usd))
```

We're going to factor these returns into buckets, and look by funding characteristics by bucket.

```{r}
grp <- c(0, 1, 5, 15, 35, 20000)
test$rfact = cut(test$return, breaks = grp,labels=c('Subpar','Low', 'Medium','High', 'Bananas'), ordered = TRUE)
plot(x = test$rfact, y = test$funding_total_usd, log = 'y', ylab = "funds raised", xlab = "quality of return")
```

This shows fairly clearly that companies are most likely to appear generate "bananas" returns if they've raised less money.  Likewise, those companies that have raised the most are in the lower-tier returns buckets.  Interesting!

Is it a statistically significant relationship?  Let's get the z score.

```{r}
ftusd <- sd(test$funding_total_usd, na.rm = TRUE)
ftumn <- mean(test$funding_total_usd, na.rm = TRUE)
a <- subset(test, test$rfact == "Bananas")
amean <- mean(a$funding_total_usd)
(amean - ftumn)/(ftusd/(sqrt(nrow(a))))
```

```{r}
b <- subset(test, test$rfact == "Subpar")
bmean <- mean(b$funding_total_usd)
(bmean - ftumn)/(ftusd/(sqrt(nrow(b))))
```

Statistically, returns in the Subpar category are much more of an outlier than those in the Bananas category. Over-raising appears to be ain indicator of lower returns.

Let's start by building a predictor model from the set of medium returns (5 - 15X):
```{r}
medset <- test$rfact == "Medium"  #select the medium companies
rtnmod <- lm(return ~ funding_total_usd, data = test, subset = medset) #build a regression of return against funding using the set
#with(test, qqPlot (return, labels = test$name, id.n=3))
```
